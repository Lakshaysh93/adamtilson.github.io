<!DOCTYPE html>
<!-- Top Navigation modified from CodingNepal - https://www.codingnepalweb.com/mega-menu-and-dropdown-menu-html-css/ -->
<!-- Side navigation modified from Sticky, Smooth, Active Nav by Chris Coyier https://codepen.io/chriscoyier/pen/qyELzd -->
<!-- Collabsibles from W3Schools https://www.w3schools.com/howto/howto_js_collapsible.asp -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> ENSE 374 Lab 9 </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/> 
  <link rel="stylesheet" href="/assets/css/style.css?v=">
  <link rel="icon" type="image/svg+xml" href="/assets/svg/at.svg">
  <!-- for mathjax support -->

</head>
<body>
  <nav id="site">
    <div class="wrapper">
      <div class="logo"><a href="#"><img
        src="/assets/svg/at.svg" alt="logo" height="35" width="35" /></a></div>
      <input type="radio" name="slider" id="menu-btn">
      <input type="radio" name="slider" id="close-btn">
      <ul class="nav-links">
        <label for="close-btn" class="btn close-btn"><i class="fas fa-times"></i></label>
        <li><a href="#">Blog</a></li>
        <li>
          <a href="#" class="desktop-item">CV ‚ñæ</a>
          <input type="checkbox" id="showDrop">
          <label for="showDrop" class="mobile-item">CV ‚ñæ</label>
          <ul class="drop-menu">
            <li><a href="#">Technical</a></li>
            <li><a href="#">Academic</a></li>
          </ul>
        </li>
        <li>
          <a href="#" class="desktop-item">Laboratory ‚ñæ</a>
          <input type="checkbox" id="showMega">
          <label for="showMega" class="mobile-item">Laboratory ‚ñæ</label>
          <div class="mega-box">
            <div class="content">


              <div class="row">
                <header>ENSE 271</header>
                <ul class="mega-links">
                  <!-- <li><a href="/labs/ense-271/">Schedule</a></li> -->
                  <!-- <li><a href="/labs/ense-271/lab-1">Lab 1</a></li> -->
                  <!-- <li><a href="/labs/ense-271/lab-2">Lab 2</a></li> -->
                  <!-- <li><a href="/labs/ense-271/lab-3">Lab 3</a></li> -->
                  <!-- <li><a href="/labs/ense-271/lab-4">Lab 4</a></li> -->
                  <!-- <li><a href="/labs/ense-271/lab-5">Lab 5</a></li> -->
                  <!-- <li><a href="/labs/ense-271/lab-6">Lab 6</a></li> -->
                  <!-- <li><a href="/labs/ense-271/lab-7">Lab 7</a></li> -->
                </ul>
              </div>

              <div class="row">
                <header>ENSE 374</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-374/">Schedule</a></li>
                  <li><a href="/labs/ense-374/lab-1">Lab 1</a></li>
                  <!-- <li><a href="/labs/ense-374/lab-2">Lab 2</a></li> -->
                  <!-- <li><a href="/labs/ense-374/lab-3">Lab 3</a></li> -->
                  <!-- <li><a href="/labs/ense-374/lab-4">Lab 4</a></li> -->
                  <!-- <li><a href="/labs/ense-374/lab-5">Lab 5</a></li> -->
                  <!-- <li><a href="/labs/ense-374/lab-6">Lab 6</a></li> -->
                  <!-- <li><a href="/labs/ense-374/lab-7">Lab 7</a></li> -->
                  <!-- <li><a href="/labs/ense-374/lab-8">Lab 8</a></li> -->
                  <!-- <li><a href="/labs/ense-374/lab-9">Lab 9</a></li> -->
                </ul>
              </div>

              <div class="row">
                <header>ENSE 411</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-411/schedule">Schedule</a></li>
                  <li><a href="/labs/ense-411/lab-0">Lab 0</a></li>
                  <!-- <li><a href="/labs/ense-411/lab-1">Lab 1</a></li> -->
                  <!-- <li><a href="/labs/ense-411/lab-2">Lab 2</a></li> -->
                  <!-- <li><a href="/labs/ense-411/lab-3">Lab 3</a></li> -->
                  <!-- <li><a href="/labs/ense-411/lab-4">Lab 4</a></li> -->
                  <!-- <li><a href="/labs/ense-411/lab-5">Lab 5</a></li> -->
                </ul>
              </div>

              <div class="row">
                <header>ENSE 472</header>
                <ul class="mega-links">
                  <li><a href="/labs/ense-472/">Schedule</a></li>
                  <li><a href="/labs/ense-472/lab-1">Lab 1</a></li>
                  <!-- <li><a href="/labs/ense-472/lab-2">Lab 2</a></li> -->
                  <!-- <li><a href="/labs/ense-472/lab-3">Lab 3</a></li> -->
                  <!-- <li><a href="/labs/ense-472/lab-4">Lab 4</a></li> -->
                  <!-- <li><a href="/labs/ense-472/lab-5">Lab 5</a></li> -->
                </ul>
              </div>
            </div>
          </div>
        </li>
        <li><a href="javascript:void(0);" id="darklink">üåûÔ∏é</a></li>
      </ul>
      <label for="menu-btn" class="btn menu-btn"><i class="fas fa-bars"></i></label>
    </div>
  </nav>
  
  <div class="body">
    <nav id="toc-nav">
      <ul id="toc">

      </ul>
    </nav>

    <main id="content" class="main-content" role="main">
        <p></p>
        <h1 id="lab-9-authorization-and-passport">Lab 9: Authorization and Passport</h1>

<p>ENSE 374 - Software Engineering Management - Laboratory</p>

<p>University of Regina - Engineering and Applied Science - Software Systems Engineering</p>

<p>Lab Instructor: <a href="mailto:Adam.Tilson@uregina.ca">Adam Tilson</a></p>

<hr />

<p><button class="expandall">Collapse All</button></p>
<section id="objective"><button class="collapsible">Objective</button><div class="text-content"><div class="text-inner">

      <p>This lab discusses important concepts for securely storing passwords in a database, and authenticating users. During implementation, we will use Passport, which handles authentication using several strategies. We will use the strategy of registering users in the local MongoDB database using mongoose, supported by a number of plugins to facilitate this process. Additionally, we will discuss sessions, and storing environment variables securely in a .env file.</p>

    </div></div></section>
<section id="equipment"><button class="collapsible">Equipment</button><div class="text-content"><div class="text-inner">

      <p>Computer running Windows, MacOS or Linux, with an Intel or AMD-based processor (x86 or x86-64) with administrator privileges.</p>
      <ul>
        <li>A modern web browser, with a strong preference for Firefox or Chrome</li>
        <li>A text editor, preferably VS Code</li>
      </ul>

    </div></div></section>
<section id="part1passwordsecurity"><button class="collapsible">Part 1: Password Security</button><div class="text-content"><div class="text-inner">

      <h3 id="background">Background</h3>

      <p>So far our to-do list is functional, but not at all secure. How can we make it more secure?</p>
      <ul>
        <li>What‚Äôs wrong with what we‚Äôve done so far?</li>
        <li>What happens if you push passwords to github?</li>
        <li>What about storing them on the cloud?</li>
        <li>What if users use the same password as in other services?</li>
      </ul>

      <h3 id="encryption">Encryption</h3>

      <p>First level of defence: scramble our passwords using encryption</p>

      <p>(This section is for information, we‚Äôll use a higher level approach!)</p>

      <ul>
        <li>If you haven‚Äôt already, you‚Äôll learn all the math behind this later. (RSA)</li>
        <li>We can use the <code class="language-plaintext highlighter-rouge">mongoose-encryption</code> package <a href="https://www.npmjs.com/package/mongoose-encryption">available on NPM</a>
          <ul>
            <li>We need two Secret strings - these are used to generate our encryption and decryption keys.</li>
            <li>They should be kept secret!</li>
            <li>We then apply the encryption to the Schema using middleware
              <ul>
                <li>Middleware are libraries which plug into existing applications and extend their functionality</li>
                <li>The middleware automatically encrypts on a save and decrypts on a read</li>
              </ul>
            </li>
          </ul>
        </li>
        <li>Now our system is only as secure as our Secret strings
          <ul>
            <li>We don‚Äôt want to just push to github!</li>
            <li>So how do we store our secret more‚Ä¶ secretly?</li>
          </ul>
        </li>
      </ul>

      <p>Is it perfect?</p>
      <ul>
        <li>No, as technology improves, what‚Äôs secure one day is much less secure the next!</li>
      </ul>

      <h3 id="environment-variables">Environment Variables</h3>

      <p>We need a method to securely store our Secrets, and other important environment variables.</p>

      <p>(We will include this approach in our final product)</p>

      <ul>
        <li>We could use tht <code class="language-plaintext highlighter-rouge">.env</code> file
          <ul>
            <li>A hidden file which can stores our secrets in a safe location</li>
            <li>We can use this for our ‚ÄúAuthorization‚Äù key in the todo list application.
              <ul>
                <li>We could also use it for any API keys</li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>

      <p>From npm:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install dotenv
</code></pre></div>      </div>

      <p>In our js file:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">dotenv</span><span class="dl">"</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>
</code></pre></div>      </div>

      <p>In our root directory:</p>

      <p>Create a <code class="language-plaintext highlighter-rouge">.env</code> file in the root.</p>
      <ul>
        <li>This is the whole name of the file
          <ul>
            <li>Similar to the <code class="language-plaintext highlighter-rouge">.gitignore</code> file</li>
          </ul>
        </li>
        <li>Save your variables here:</li>
      </ul>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DB_HOST=localhost
DB_USER=root
</code></pre></div>      </div>

      <p>No quotations for strings. Multiple words after the equals are fine.</p>

      <p>Access in variables in our node js file:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_HOST</span>
</code></pre></div>      </div>

      <p>Finally, add this file to your gitignore!</p>
      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.env
</code></pre></div>      </div>

      <p>This will keep the file from getting pushed to the github.</p>

      <p>When you upload your files to the server, securely upload your Environment Variables rather than push and pulling from GitHub!</p>

      <h3 id="hashing">Hashing</h3>

      <p>Next level of defence: Hashing</p>

      <p>(This section is for information, we‚Äôll use a higher level approach!)</p>

      <p>Hash functions are a mathematical equation which turns a string into a hash code</p>
      <ul>
        <li>Deterministic, so the same input always produces the same hash</li>
        <li>It‚Äôs impossible (or at least ridiculously hard) to go backwards
          <ul>
            <li>This is called a ‚Äúone-way function‚Äù</li>
          </ul>
        </li>
      </ul>

      <p>We know going forward function call produces consistent results
    - At registration time, we can ask for a password, 
      - hash it, 
      - and store the hashed value in our database. 
    - At login time, the user enters the password
      - the entered password is hashed 
      - and if the hashed value matches what‚Äôs in the database,
      - the password must be correct!
    - Unfortunately hash functions can have multiple inputs map to the same output, but it‚Äôs incredibly rare</p>

      <p>Example: <a href="http://www.md5.cz/">MD5 application</a></p>

      <p>How can we beat this?</p>
      <ul>
        <li>Make a hash table of common passwords, and compare.</li>
        <li>Modern GPUs can do 20Bill Hashes per Second!</li>
      </ul>

      <p>How else can we improve security?</p>

      <p>Use a slow hashing function, like bcrypt</p>
      <ul>
        <li>This will slow down brute forcing</li>
        <li>But technology will improve</li>
      </ul>

      <h3 id="salting-and-hashing">Salting and Hashing</h3>

      <p>Let‚Äôs upgrade our security one more level:</p>

      <p>Add a salt and then hash!</p>

      <p>(This is what we‚Äôll do, but we‚Äôll have Passport do it for us!)</p>

      <ul>
        <li>generate a random string, called a Salt
          <ul>
            <li>concatenate it to the password</li>
            <li>hash the whole thing!
              <ul>
                <li>This will produce a different value than only hashing the password</li>
              </ul>
            </li>
            <li>Save the salt into the database too for future reuse</li>
            <li>When testing new use passwords,
              <ul>
                <li>grab the old salt</li>
                <li>concatenate it to the new password</li>
                <li>hash the whole thing</li>
                <li>check that they match</li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>

      <p>Want more security?</p>
      <ul>
        <li>Salting rounds!
          <ul>
            <li>salt it, hash it, salt it, hash it,</li>
            <li>do it 5 times?</li>
            <li>each salt/hash round doubles the time to compute it.</li>
          </ul>
        </li>
      </ul>

      <p>Can we do this manually in node? sure!</p>

      <p><code class="language-plaintext highlighter-rouge">bcrypt</code> <a href="https://www.npmjs.com/package/bcrypt">Bcrypt on NPM</a></p>
      <ul>
        <li>you can hash, choose the number of salt rounds, etc.</li>
        <li>However, we‚Äôll have Passport do this for us!</li>
      </ul>

    </div></div></section>
<section id="part2authentication"><button class="collapsible">Part 2: Authentication</button><div class="text-content"><div class="text-inner">

      <h3 id="cookies">Cookies</h3>

      <p>Once the user is logged in, how do we track which user they are?
    - This is done through cookies and sessions</p>

      <p>Cookies are delicious delicacies - Mozilla, 1999</p>
      <ul>
        <li>a piece of persistent data that is stored on the users browser
          <ul>
            <li>It can be used to authorize a user by means of an ‚Äúaccess token‚Äù
              <ul>
                <li>a hash which identifies which user is logged in.</li>
              </ul>
            </li>
          </ul>
        </li>
        <li>Cookies persist between visits, which is why you do not need to manually log back into websites</li>
      </ul>

      <h3 id="sessions">Sessions</h3>

      <p>Sessions, on the other hand, persist only during one visit to a website</p>
      <ul>
        <li>A session is one complete dialogue between the client and the server</li>
        <li>You can think of it like a lock being generated on the server side
          <ul>
            <li>We give the user the key, and store it inside a cookie</li>
            <li>When the user presents the cookie with the key, if it unlocks, we let them in</li>
            <li>The sessions ends when the server changes the lock (typically after a certain amount of time),
              <ul>
                <li>the user discards the key (when closing the browser)</li>
                <li>or ideally both (logging out)</li>
              </ul>
            </li>
          </ul>
        </li>
        <li>We will be using sessions to keep our users authorized during one visit, until they log out</li>
      </ul>

      <h3 id="open-authorization-oauth">Open Authorization (OAuth)</h3>

      <p>Beyond the scope of this lab but worth mentioning:</p>
      <ul>
        <li>OAuth is the cool new approach and open standard for authorization</li>
        <li>We essentially subcontract another company to do authorization for us
          <ul>
            <li>Google, FaceBook, GitHub, etc.</li>
            <li>The user logs in with their credentials for that account</li>
            <li>The third party verifies the users identity without exchanging any passwords. Cool!
              <ul>
                <li>You put all your trust in one company rather than distributing it around</li>
              </ul>
            </li>
          </ul>
        </li>
        <li>This is possible to achieve using passport OAuth modules, but we will not look into it for this lab.</li>
      </ul>

    </div></div></section>
<section id="part3passportusageandexample"><button class="collapsible">Part 3: Passport Usage and Example</button><div class="text-content"><div class="text-inner">

      <p>Let‚Äôs see how this authorization works by example.</p>
      <ul>
        <li>We‚Äôll build on our Game Review submission application from last week.</li>
        <li>We are basically starting from where we made it last week,
          <ul>
            <li>with some minor adjustments for what we‚Äôre doing today:</li>
          </ul>
        </li>
      </ul>

      <p>Set up the following directory structure:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|-- /views
|    |-- reviews.ejs
|    |-- add-review.ejs
|-- .env
|-- index.html
|-- app.js
</code></pre></div>      </div>

      <p>in <code class="language-plaintext highlighter-rouge">/views/reviews.ejs</code></p>
      <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Document<span class="nt">&lt;/title&gt;</span>
    <span class="c">&lt;!-- Styles from w3Schools table tutorial --&gt;</span>
    <span class="nt">&lt;style&gt;</span>
        <span class="nt">table</span> <span class="p">{</span>
          <span class="nl">font-family</span><span class="p">:</span> <span class="n">arial</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
          <span class="nl">border-collapse</span><span class="p">:</span> <span class="nb">collapse</span><span class="p">;</span>
          <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="nt">td</span><span class="o">,</span> <span class="nt">th</span> <span class="p">{</span>
          <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#dddddd</span><span class="p">;</span>
          <span class="nl">text-align</span><span class="p">:</span> <span class="nb">left</span><span class="p">;</span>
          <span class="nl">padding</span><span class="p">:</span> <span class="m">8px</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="nt">tr</span><span class="nd">:nth-child</span><span class="o">(</span><span class="nt">even</span><span class="o">)</span> <span class="p">{</span>
          <span class="nl">background-color</span><span class="p">:</span> <span class="m">#dddddd</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;th&gt;</span>User Name<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Game Name<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Score<span class="nt">&lt;/th&gt;</span>
            <span class="nt">&lt;th&gt;</span>Review Text<span class="nt">&lt;/th&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>
    <span class="nt">&lt;tbody&gt;</span>
    <span class="c">&lt;!-- We want to repeat this for each game in the database --&gt;</span>
    <span class="nt">&lt;</span><span class="err">%</span> <span class="na">for</span> <span class="err">(</span><span class="na">const</span> <span class="na">result</span> <span class="na">of</span> <span class="na">results</span><span class="err">)</span> <span class="err">{</span> <span class="err">%</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tr&gt;</span>
            <span class="nt">&lt;td&gt;&lt;</span><span class="err">%=</span> <span class="na">result.userName</span> <span class="err">%</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;</span><span class="err">%=</span> <span class="na">result.gameName</span> <span class="err">%</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;</span><span class="err">%=</span> <span class="na">result.score</span> <span class="err">%</span><span class="nt">&gt;&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;&lt;</span><span class="err">%=</span> <span class="na">result.reviewText</span> <span class="err">%</span><span class="nt">&gt;&lt;/td&gt;</span>
        <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;</span><span class="err">%</span> <span class="err">}</span> <span class="err">%</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- End repeating bit --&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/add-review"</span> <span class="na">method=</span><span class="s">"get"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Add a Review!"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/logout"</span> <span class="na">method=</span><span class="s">"get"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Log Out!"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>      </div>

      <p>Let‚Äôs modify our <code class="language-plaintext highlighter-rouge">index.html</code> into <code class="language-plaintext highlighter-rouge">add-review.ejs</code></p>

      <p>in <code class="language-plaintext highlighter-rouge">/views/add-review.ejs</code></p>

      <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Add Reviews<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/submit"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"gameName"</span><span class="nt">&gt;</span>Game Name<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"gameName"</span> <span class="na">id=</span><span class="s">"gameName"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"score"</span><span class="nt">&gt;</span>Score<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"score"</span> <span class="na">id=</span><span class="s">"score"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"reviewText"</span><span class="nt">&gt;</span>Review Text<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"reviewText"</span> <span class="na">id=</span><span class="s">"reviewText"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>      </div>

      <p>Let‚Äôs add a new register and sign up page, <code class="language-plaintext highlighter-rouge">index.html</code></p>

      <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Register or Log In<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body</span> <span class="na">class=</span><span class="s">"text-center"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form-signin"</span> <span class="na">action=</span><span class="s">"/register"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Register<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputEmail"</span><span class="nt">&gt;</span>Email address<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"email"</span> <span class="na">id=</span><span class="s">"inputEmail"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Email address"</span> <span class="na">required</span> <span class="na">autofocus</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputPassword"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">id=</span><span class="s">"inputPassword"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Password"</span> <span class="na">required</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-lg btn-primary btn-block"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">"form-signin"</span> <span class="na">action=</span><span class="s">"/login"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Sign in<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputEmail"</span><span class="nt">&gt;</span>Email address<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"email"</span> <span class="na">id=</span><span class="s">"inputEmail"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Email address"</span> <span class="na">required</span> <span class="na">autofocus</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputPassword"</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">id=</span><span class="s">"inputPassword"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Password"</span> <span class="na">required</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-lg btn-primary btn-block"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>Sign in<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</code></pre></div>      </div>

      <p>And finally, our <code class="language-plaintext highlighter-rouge">app.js</code></p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span> <span class="p">);</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span> <span class="p">);</span>

<span class="c1">// 1. Require dependencies /////////////////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// this is a canonical alias to make your life easier, like jQuery to $.</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span> 
<span class="c1">// a common localhost test port</span>
<span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span> 

<span class="c1">// body-parser is now built into express!</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span> <span class="nx">express</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">(</span> <span class="p">{</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">)</span> <span class="p">);</span> 

<span class="c1">// 2. Create a session. The secret is used to sign the session ID.</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>


<span class="nx">app</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span> <span class="dl">"</span><span class="s2">view engine</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ejs</span><span class="dl">"</span> <span class="p">);</span>

<span class="c1">// connect to mongoose on port 27017</span>
<span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span> <span class="dl">'</span><span class="s1">mongodb://localhost:27017/games</span><span class="dl">'</span><span class="p">,</span> 
                 <span class="p">{</span> <span class="na">useNewUrlParser</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">useUnifiedTopology</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="c1">// 3. Create the userSchema ////////////////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="kd">const</span> <span class="nx">gameSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">({</span>
    <span class="na">userName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">gameName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">score</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span>
    <span class="na">reviewText</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">});</span>

<span class="kd">const</span> <span class="nx">Game</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span> <span class="dl">"</span><span class="s2">Game</span><span class="dl">"</span><span class="p">,</span> <span class="nx">gameSchema</span> <span class="p">);</span>


<span class="c1">// 4. Add our strategy for using Passport, using the local user from MongoDB</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// Simple server operation</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="p">(</span> <span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// template literal</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="p">(</span> <span class="s2">`Server is running on http://localhost:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span> <span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 5. Register a user with the following code, which needs to be in the appropriate route</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// 6. Log in users on the login route //////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is accessing the root route using get</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/index.html</span><span class="dl">"</span> <span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 7. Register get routes for reviews and add-review ///////////////</span>
<span class="c1">//Your code will replace this section!</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is accessing the reviews route using get, and found:</span><span class="dl">"</span> <span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">results</span> <span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="dl">"</span><span class="s2">reviews</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">results</span> <span class="p">:</span> <span class="nx">results</span> <span class="p">});</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="nx">error</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">error</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/add-review</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is accessing the add-review route using get</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="dl">"</span><span class="s2">add-review</span><span class="dl">"</span> <span class="p">);</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// 8. Logout ///////////////////////////////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>

<span class="c1">// 9. Submit a post to the database ////////////////////////////////</span>
<span class="c1">//Your code here!</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <p>And set up our requirements with:</p>
      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm init
npm i express ejs mongoose
</code></pre></div>      </div>

      <p>Make sure <code class="language-plaintext highlighter-rouge">mongod</code> is running!</p>

      <h3 id="required-packages">Required packages</h3>

      <p>We are going to install the following packages:</p>

      <ul>
        <li><code class="language-plaintext highlighter-rouge">passport</code> - An authentication middleware for express making use of different strategies</li>
        <li><code class="language-plaintext highlighter-rouge">passport-local</code> - A username and password authentication strategy</li>
        <li><code class="language-plaintext highlighter-rouge">passport-local-mongoose</code> - Simplifies using username/password with Mongo</li>
        <li><code class="language-plaintext highlighter-rouge">express-session</code> (not express-sessions) -Middleware for creating sessions.</li>
      </ul>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i passport passport-local passport-local-mongoose express-session dotenv
</code></pre></div>      </div>

      <p>Note: It‚Äôs very important to use these snippets in the order they are used in this example. I have thus included locations in the sample code for where to insert each bit by number!</p>

      <h3 id="add-needed-packages">Add needed packages:</h3>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. Require dependencies /////////////////////////////////////////</span>
<span class="kd">const</span> <span class="nx">session</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">express-session</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">passport</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">passportLocalMongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">passport-local-mongoose</span><span class="dl">"</span><span class="p">)</span>
<span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">dotenv</span><span class="dl">"</span><span class="p">).</span><span class="nx">config</span><span class="p">();</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <p>We don‚Äôt need  to directly user passport-local, so don‚Äôt need access to it through a const</p>

      <h3 id="set-up-the-dotenv-file">Set up the dotenv file</h3>

      <p>Create and add the following to the <code class="language-plaintext highlighter-rouge">/.env</code> file:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SECRET=Something secret to encrypt our session
</code></pre></div>      </div>

      <h3 id="use-session">Use session</h3>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 2. Create a session. The secret is used to sign the session ID.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">session</span><span class="p">({</span>
    <span class="na">secret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span><span class="p">,</span>
    <span class="na">resave</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">saveUninitialized</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}));</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="create-the-userschema">Create the userSchema</h3>

      <p>We need to use a specific schema for passport-local-mongoose, make sure your fields are named as follows:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 3. Create the userSchema /////////////////////////////////////////</span>
<span class="c1">// It is important not to change these names</span>
<span class="c1">// passport-local-mongoose expects these. Use `username` and `password`!</span>
<span class="kd">const</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span> <span class="p">({</span>
    <span class="na">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">password</span><span class="p">:</span> <span class="nb">String</span>
<span class="p">})</span>

<span class="c1">// plugins extend Schema functionality</span>
<span class="nx">userSchema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">passportLocalMongoose</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="dl">"</span><span class="s2">User</span><span class="dl">"</span><span class="p">,</span> <span class="nx">userSchema</span><span class="p">);</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="set-our-passport-strategy">Set our Passport strategy:</h3>

      <p>This section creates the Passport strategy, and encodes our user into the session. 
passportLocalMongoose, which we plugged in earlier, is doing the heavy lifting for us.</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 4. Add our strategy for using Passport, using the local user from MongoDB</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">createStrategy</span><span class="p">());</span>

<span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">());</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">());</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="register-users">Register users:</h3>

      <p>Add the following snippet to register users.</p>

      <p>Note the weird syntax on <code class="language-plaintext highlighter-rouge">passport.authenticate</code>. This is a higher-order function which returns a function, (i.e. a function factory,) the second set of args are passed to the returned function.</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 5. Register a user with the following code, which needs to be in the appropriate route</span>
<span class="c1">// As in (3), be sure to use req.body.username and req.body.password, and ensure the </span>
<span class="c1">// html forms match these values as well</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/register</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">User </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> is attempting to register</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span> <span class="na">username</span> <span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="p">},</span> 
                    <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> 
                    <span class="p">(</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">user</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span> <span class="dl">"</span><span class="s2">local</span><span class="dl">"</span> <span class="p">)(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span> <span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <p>Once signed in, we can get the username with:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span>
</code></pre></div>      </div>

      <h3 id="log-in-users">Log-in Users:</h3>

      <p>Logging in users is similar to registering users‚Ä¶</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 6. Log in users on the login route ////////////////////////////////</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/login</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">User </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> is attempting to log in</span><span class="dl">"</span> <span class="p">);</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span> <span class="p">({</span>
        <span class="na">username</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
        <span class="na">password</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">});</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">login</span> <span class="p">(</span> <span class="nx">user</span><span class="p">,</span> <span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">err</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span> <span class="dl">"</span><span class="s2">local</span><span class="dl">"</span> <span class="p">)(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span> <span class="p">);</span> 
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="allow-in-authenticated-users">Allow in authenticated users</h3>

      <p>Only users who are authenticated should be able to access the <code class="language-plaintext highlighter-rouge">reviews</code> page. Ditto for the <code class="language-plaintext highlighter-rouge">add-review</code> page</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 7. Register get routes for reviews and add-review ////////////////</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">A user is accessing the reviews route using get, and...</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nx">req</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">()</span> <span class="p">){</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">was authorized and found:</span><span class="dl">"</span> <span class="p">);</span>
            <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Game</span><span class="p">.</span><span class="nx">find</span><span class="p">();</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">results</span> <span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="dl">"</span><span class="s2">reviews</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">results</span> <span class="p">:</span> <span class="nx">results</span> <span class="p">});</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span> <span class="nx">error</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">error</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">was not authorized.</span><span class="dl">"</span> <span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/add-review</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is accessing the add-review page, and...</span><span class="dl">"</span> <span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">isAuthenticated</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">was authorized</span><span class="dl">"</span> <span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span> <span class="dl">"</span><span class="s2">add-review</span><span class="dl">"</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">was not authorized</span><span class="dl">"</span> <span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/</span><span class="dl">"</span> <span class="p">)</span> 
    <span class="p">}</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="log-out-users">Log-out Users:</h3>

      <p>We can log out users on the logout route with the following</p>
      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 8. Logout ///////////////////////////////////////////////////////</span>
<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/logout</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">A user is logging out</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">logout</span><span class="p">();</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">"</span><span class="s2">/</span><span class="dl">"</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <h3 id="using-the-session-when-posting-reviews">Using the session when posting reviews:</h3>

      <p>Finally, lets complete our application by by adding in the submit route:</p>

      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 9. Submit a post to the database ////////////////////////////////</span>
<span class="c1">// Note that in the username, we are using the username from the</span>
<span class="c1">// session rather than the form</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/submit</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span><span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span> <span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="dl">"</span><span class="s2">User </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> is adding the review:</span><span class="dl">"</span> <span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class="p">)</span>
    <span class="kd">const</span> <span class="nx">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Game</span><span class="p">({</span>
        <span class="na">userName</span><span class="p">:</span>   <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
        <span class="na">gameName</span><span class="p">:</span>   <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">gameName</span><span class="p">,</span>
        <span class="na">score</span><span class="p">:</span>      <span class="nb">parseInt</span><span class="p">(</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">score</span> <span class="p">),</span>
        <span class="na">reviewText</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">reviewText</span>
    <span class="p">});</span>

    <span class="nx">game</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span> <span class="dl">"</span><span class="s2">/reviews</span><span class="dl">"</span> <span class="p">);</span>
<span class="p">});</span>
<span class="c1">////////////////////////////////////////////////////////////////////</span>
</code></pre></div>      </div>

      <p>Note, when you restart your server (which nodemon does frequently!) all of the cookies expire, so you will need to log in again.</p>

    </div></div></section>
<section id="labassignment"><button class="collapsible">Lab Assignment</button><div class="text-content"><div class="text-inner">

      <p>For the final big assignment, you will add complete database integration into the application from Lab 7. You finally have a stack which is ready for a production environment!</p>

      <h3 id="schema">Schema</h3>

      <p>Update you Schemas from Lab 8, if needed, to work with Passport / Mongoose</p>

      <h3 id="user-registration-and-login">User registration and login:</h3>

      <p>Modify the login page on the ‚Äú/‚Äù route.</p>

      <p>Link the login form to the ‚Äú/login‚Äù route with POST. In this route perform the following:</p>
      <ul>
        <li>Using passport, log in and authenticate the user</li>
        <li>If authentication fails, redirect back to ‚Äú/‚Äù</li>
        <li>If registration succeeds, redirect to ‚Äú/todo‚Äù</li>
      </ul>

      <p>Link the register form to the ‚Äú/register‚Äù route. In this route perform the following:</p>
      <ul>
        <li>Register a new user using passport</li>
        <li>If registration fails, redirect back to ‚Äú/‚Äù</li>
        <li>If registration succeed, redirect to ‚Äú/todo‚Äù</li>
        <li>The Authentication key, which is checked against when registering users, should be stored in the <code class="language-plaintext highlighter-rouge">.env</code> file!</li>
      </ul>

      <p><code class="language-plaintext highlighter-rouge">todo</code> should only be available to Authenticated users.</p>
      <ul>
        <li>As long as user is authenticated, they should be able to return to ‚Äú/todo‚Äù without logging in again, until the cookie expires or they log out.</li>
      </ul>

      <h3 id="to-do-list-display">To-do list display</h3>

      <p>Use EJS to render the to-do list on the <code class="language-plaintext highlighter-rouge">/todo</code> route</p>

      <ul>
        <li>
          <p>Modify your code from Lab 7 to instead read from the database.</p>
        </li>
        <li>
          <p>Reuse as much code as possible! The front-end should have minimal to no changes.</p>
        </li>
      </ul>

      <h3 id="to-do-list-functionality">To-do list functionality</h3>

      <p>Modify the code from Lab 7 to use the database.</p>
      <ul>
        <li>All of the same functionality should exist,
          <ul>
            <li>Now all operations should read and write to the database instead read from the database rather than the JSON file</li>
          </ul>
        </li>
      </ul>

      <h3 id="submission">Submission</h3>

      <p>Please submit to URCourses by the due date!</p>

      <h3 id="aside-the-next-steps">Aside: The Next Steps</h3>

      <p>If Full-Stack Web Dev has won you over as your dream job, in my opinion, the most important things we did not cover in this lab are:</p>

      <ul>
        <li>
          <p>A modern View engine, such as <a href="https://reactjs.org/">React</a>, <a href="https://angular.io/">Angular</a> or <a href="https://vuejs.org/">Vue.js</a></p>
        </li>
        <li>
          <p>Better JavaScript with <a href="https://www.typescriptlang.org/">TypeScript</a></p>
        </li>
        <li>
          <p>Having your Browser-side JavaScript talk directly to the Server-side Node.js, e.g. with AJAX, or with the Fetch API</p>
          <ul>
            <li>With this you could link up Labs 5 and 9 to create a site which updates on demand without refreshing the page!</li>
            <li>With this, if our to-do list app was live, we could periodically check if other users had added new data, and if so automatically update our site using the DOM</li>
            <li>This is how infinite scroll websites fetch data without reloading the page!</li>
          </ul>
        </li>
      </ul>

      <p>An example of how this would work with AJAX <a href="https://stackoverflow.com/questions/53897250/how-to-call-a-server-side-nodejs-function-using-client-side-javascript">found on StackOverflow</a></p>

      <p>In Node.js with Express:</p>
      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/hello</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Your function to be called goes here.</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="na">data</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span> <span class="p">})</span>
<span class="p">});</span>
</code></pre></div>      </div>

      <p>In JavaScript using jQuery:</p>
      <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/hello</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span> 
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">error</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>      </div>

      <ul>
        <li>Level up our MVC / Model with a <a href="https://www.redhat.com/en/topics/api/what-is-a-rest-api">REST API</a></li>
      </ul>
    </div></div></section>

    </main>

  </div>
  <footer>
    2021 Adam Tilson.
    <a href="https://creativecommons.org/licenses/by-nc-sa/2.0/"
      >CC-BY-NC-SA</a
    >
  </footer>
  <button onclick="topFunction()" id="topButton" title="Go to top">‚ñ≤ Top</button> 
  <script src="/assets/js/script.js"></script>

</body>
</html>
